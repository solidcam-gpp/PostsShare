; 00155 _ Version:SolidCAM 2017 SP4 DV 89920 Auto checking date:26/03/2018 _ result: pass
; 00155 _ Version:SolidCAM 2017 SP4 DV 89632 Auto checking date:13/03/2018 _ result: pass
; 00155 _ Version:SolidCAM 2017 SP3 DV 89254 Auto checking date:27/02/2018 _ result: pass
; 00155 _ Version:SolidCAM 2017 SP2 DV 86565 Auto checking date:02/01/2018 _ result: pass
;c/n 00155
; 00155_Version:SolidCAM 2015 SP3 HF3 61533 Auto checking date:15/09/15 _ result: pass
;DialogBox: trace_level/integer(0)
;Fanuc 3x
;Michael V. 4/8/2013 New post
;FROM MASTER
@init_post
	global logical LogFirst_move
	global string StrSpin_f
	xpos_f				= '< X>5.3'
	ypos_f				= '< Y>5.3'
	zpos_f				= '< Z>5.3'
	gcode_f				= '<G>3.1(p)'
	mcode_f				= '<M>3.1(p)'
	StrSpin_f				= '< S>5.3(p)'
	feed_f				= '< F>5.3(p)'
	gcode_space		= true
	blknum_gen		= false
	blknum			= 1
	blknum_max		= 99999
	blknum_delta	= 2
	;Input "Trace level : 0-None ; 5-All", trace_level
	;trace "all":trace_level
endp

@new routine

endp
@start_of_file
	{'%'}
	{nb,'O',program_number:'z4.0(p)','(',g_file_name,')'}
	{nb,'(DRW N: ',part_name,')'}
	{nb,'(',date,' ',time,')'}
	gcode= 53+home_number
	{nb,'G80 G40 G17 G69 ',gcode}
endp

@def_tool
	{nb,'G90 G10 L12 P',tool_number,' R',tool_offset}
	{'(TOOL N',tool_number,' ',tool_user_type,' DIA:'tool_diameter,')'}
endp

@absolute_mode
	gcode = 90
	{nb,gcode,' '}
	skipline = false
endp

@relative_mode
	gcode = 91
	{nb,gcode,' '}
	skipline = false
endp

@change_tool
	call @UdrStop_cool
	{nb,'G91 G28 G0 Z0'}
	call @machine_opt_stop
	mcode = 6
	{nb,'T',tool_number,' ',mcode}
	{'(TOOL N',tool_number,' ',tool_user_type,' DIA:'tool_diameter,')'}
	blknum_gen = false
	if tool_number ne next_tool_number
		{nb,'T',next_tool_number}
	endif
	LogFirst_move = true
endp

@machine_opt_stop
	mcode = 1
	{nb,mcode}
endp

@UdrStart_cool
	mcode = 8
	{nb,mcode}
endp

@UdrStop_cool
	mcode = 9
	{nb,mcode}
endp

@start_of_job
	if LogFirst_move eq true
		gcode = 0
		{nb,gcode,xnext:xpos_f,ynext:ypos_f}
		gcode = 43
		{nb,gcode,' H',tool_number,' D',tool_number,job_start_level:zpos_f}
	endif
endp

@message
	{nb,'(',upper(message),')'}
endp

@m_feed_spin
	if LogFirst_move eq true or change(spin) eq true
		mcode = 3+spin_direction
		{nb,mcode,spin}
		call @UdrStart_cool
		LogFirst_move = false
	endif
endp

@rapid_move
	gcode = 0
	{nb,[gcode],[xpos],[ypos],[zpos]}
endp

@line
	gcode = 1
	{nb,[gcode],[xpos],[ypos],[zpos],[feed]}
endp

@arc
	gcode = 2+arc_direction
	{nb,[gcode],[xpos],[ypos],[zpos]}
	if arc_size gt 180
		{' I'xcenter_rel,' J'ycenter_rel}
	else
		{' R'radius}
	endif
	{[feed]}
endp

@compensation
	gcode = 42-side
	{nb,gcode ' ' }
	skipline = false
endp

@end_program
	{nb,'G28 G91 G0 Z0'}
	{nb,'G28 G91 G0 Y0'}
	mcode = 30
	{nb,mcode}
endp

@end_of_file
	{nl,'%'}
endp

@drill
	call @rapid_move
	gcode = 98
	{nb,gcode,' '}
	if drill_type eq Drilling
		gcode = 81
	endif
	if drill_type eq Peck
		gcode = 83
	endif
	if drill_type eq Tapping
		gcode = 95
		{gcode,' '}
		gcode = 84
	endif
	if drill_type eq Boring
		gcode = 85
	endif
	{gcode,xpos,ypos,drill_lower_z:zpos_f,' R',drill_upper_z}
	if drill_type eq Peck
		{' Q'down_step}
	endif
	if drill_type eq Tapping
		{(feed/spin):feed_f}
	else
		{feed}
	endif
endp

@drill_point
	if first_drill eq false
		{nb,'   ',[xpos],[ypos]}
	endif
endp

@end_drill
	{nb,'G80'}
	if drill_type eq Tapping
		gcode = 94
		{' ',gcode}
	endif
endp

@change_ref_point
	{nb,'G91 G10 L2 P6',xhome:xpos_f,yhome:ypos_f,zhome:zpos_f}
	{nb,'G90'}
endp

@loop
	{nb,'WHILE [ #'loop_level,' LT 'loop_count,'] DO',loop_level}
endp

@rotate
	if rotate_cancel eq true
		gcode = 69
		{nb,gcode}
	else
		gcode = 68
		{nb,'G91 'gcode,rot_x_point:xpos_f,rot_y_point:ypos_f,' R',angle}
		{nb,'G90'}
	endif
endp

@end_loop
	{nb,'#'loop_level,'=#',loop_level,'+1'}
	{nb,'END',loop_level}
endp

@call_proc
	mcode = 98
	skipline = false
	call @message
	skipline = true
endp

@proc
	{nl,'%'}
	{nl,'O'label}
	skipline = false
	call @message
	skipline = true
endp

@end_proc
	mcode = 99
	{nb,mcode}
endp



